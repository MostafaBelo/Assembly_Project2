(()=>{"use strict";const t=new class{address_size=24;S=0;L=0;C=0;associativity=0;accesses=0;hits=0;miss=0;memory_time=0;missPenalty=120;hitPenalty=1;mem={};constructor(t=0,e=0,s=0){this.S=t,this.L=e,this.C=this.S/this.L,this.associativity=s}setPenalty(t=120,e=1){this.missPenalty=t,this.hitPenalty=e}isIndexInCache(t){return(t=parseInt(t,2))in this.mem}isvalid(t,e){for(let s=t=parseInt(t,2);s<t+this.associativity;s++)if(s in this.mem&&this.mem[s].valid&&this.mem[s].tag===e)return!0;return!1}getRandomInt(t,e){return Math.floor(Math.random()*(e-t)+t)}setAddressSize(t=24){this.address_size=t}read(t){t=function(t,e=32){if(1==t>>e-1){let s=1;for(let t=0;t<32-e-1;t++)s<<=1,s|=1;s<<=e,t|=s}return(t>>>0).toString(2).padStart(e,"0")}(t,this.address_size);let e=Math.log2(this.L),s=Math.log2(this.C/this.associativity),i=this.address_size-e-s,a=t.slice(0,i),n=t.slice(i,i+s),o=t.slice(i+s,this.address_size);this.accesses++,this.isIndexInCache(n)&&this.isvalid(n,a)?(this.hits++,this.memory_time+=this.hitPenalty):this.write(a,n,o)}getHitsRatio(){return 0===this.accesses?0:this.hits/this.accesses}getMissessRatio(){return 0===this.accesses?0:this.miss/this.accesses}getAMAT(){return 0===this.accesses?0:this.memory_time/this.accesses}write(t,e,s){this.miss++,this.memory_time+=this.missPenalty;for(let s=e=parseInt(e,2);s<e+this.associativity;s++)if(!(s in this.mem))return void(this.mem[s]={valid:!0,tag:t});e=this.getRandomInt(e,e+this.associativity),this.mem[e]={valid:!0,tag:t}}init(t=0,e=0,s=0){this.S=t,this.L=e,this.C=this.S/this.L,this.associativity=s,this.accesses=0,this.hits=0,this.miss=0,this.memory_time=0,this.mem={}}},e=new class{ui=void 0;isPlaying=!1;parser=void 0;currentInstruction=0;constructor(){}setUI(t){this.ui=t}setParser(t){this.parser=t}setupUI(t){void 0!==t&&this.setUI(t),this.ui.onPlay=()=>{this.startExecution()},this.ui.onStop=()=>{this.stopExecution()},this.ui.onNext=()=>{this.executeNext()},this.ui.onFallThrough=()=>{this.executeAll()}}getInstructions(){return this.parser.parsed}startExecution(){if(this.isPlaying)return;this.isPlaying=!0;let e=this.ui.codeContent;if(this.parser.takeFile(e),!this.parser.validate_reads())return alert("Failed to parse code"),void(this.isPlaying=!1);this.parser.seperate_reads();let s=this.ui.s,i=this.ui.l,a=this.ui.associativity;t.init(s,i,a),this.currentInstruction=0,this.ui.setCurrentTab("execution")}executeNext(){this.isPlaying&&(this.executeCommand(),this.ui.update())}executeAll(){if(this.isPlaying){for(;this.isPlaying;)this.executeCommand();this.ui.update()}}stopExecution(){this.isPlaying&&(this.isPlaying=!1,this.ui.setCurrentTab("code"))}executeCommand(){if(this.getInstructions().length===this.currentInstruction)return void(this.isPlaying=!1);const e=this.getInstructions()[this.currentInstruction];console.log(e,typeof e),t.read(e),this.currentInstruction++}},s=new class{codeAreaWrapper=document.getElementById("codeArea");codeLineHighlight=document.getElementById("highlight-line");codeLineNumbersArea=document.getElementById("codeLineNumbers");codeArea=document.getElementById("code");memArea=document.getElementById("mem");code_actions_btns={open_file_input:document.getElementById("open-file-choose-input"),play_btn:document.getElementById("play-btn"),stop_btn:document.getElementById("stop-btn"),next_btn:document.getElementById("next-btn"),fall_through_btn:document.getElementById("fall-through-btn")};code_tabs={code_tab:document.getElementById("code-tab"),execution_tab:document.getElementById("execution-tab")};details_inputs={s:document.getElementById("S-input"),l:document.getElementById("L-input"),associativity:document.getElementById("associativity-input"),accesses:document.getElementById("accesses-input"),hits:document.getElementById("hits-input"),misses:document.getElementById("misses-input"),amat:document.getElementById("amat-input"),first_cache_address:document.getElementById("first-cache-address-input")};cache=void 0;flow=void 0;onPlay=()=>{};onStop=()=>{};onNext=()=>{};onFallThrough=()=>{};firstAddress=8e3;currentTab="code";codeContent="";s=0;l=0;associativity=1;constructor(){}setCache(t){this.cache=t}setFlow(t){this.flow=t}setupCode(){this.codeAreaWrapper.onclick=t=>{this.codeArea.focus()},this.codeArea.addEventListener("input",(t=>{let e=t.target.value;const s=e.split("\n").length;this.codeLineNumbersArea.innerHTML=Array(s).fill("<span></span>").join(""),"code"===this.currentTab&&(this.codeContent=e)}),!1),this.code_actions_btns.open_file_input.onchange=t=>{let e=this.code_actions_btns.open_file_input.files[0],s=new FileReader;s.readAsText(e,"UTF-8"),this.code_actions_btns.open_file_input.value="",s.onload=t=>{let e=t.target.result;this.codeArea.value=e,this.update()}},this.code_actions_btns.play_btn.onclick=t=>{this.onPlay()},this.code_actions_btns.stop_btn.onclick=t=>{this.onStop()},this.code_actions_btns.next_btn.onclick=t=>{this.onNext()},this.code_actions_btns.fall_through_btn.onclick=t=>{this.onFallThrough()},this.code_tabs.code_tab.onclick=t=>{this.flow.isPlaying||this.setCurrentTab("code")},this.code_tabs.execution_tab.onclick=t=>{this.flow.isPlaying&&this.setCurrentTab("execution")},this.updateCode()}setupCache(){this.updateCache()}setupDetails(){this.details_inputs.s.value=0,this.details_inputs.l.value=0,this.details_inputs.associativity.value=1,this.details_inputs.accesses.value="0",this.details_inputs.hits.value="0 (0%)",this.details_inputs.misses.value="0 (0%)",this.details_inputs.amat.value="0",this.details_inputs.first_cache_address.value=0,this.details_inputs.s.oninput=t=>{let e=this.details_inputs.s.value;this.s=parseInt(e),this.update()},this.details_inputs.l.oninput=t=>{let e=this.details_inputs.l.value;this.l=parseInt(e),this.update()},this.details_inputs.associativity.oninput=t=>{let e=this.details_inputs.associativity.value;this.associativity=parseInt(e),this.update()},this.details_inputs.first_cache_address.oninput=t=>{let e=this.details_inputs.first_cache_address.value;this.firstAddress=parseInt(e),this.update()},this.updateDetails()}setup(t,e){void 0!==t&&this.setCache(t),void 0!==e&&this.setFlow(e),this.setupCode(),this.setupCache(),this.setupDetails()}updateCode(){this.flow.isPlaying?(this.code_actions_btns.play_btn.style.display="none",this.code_actions_btns.stop_btn.style.display="flex","execution"!==this.currentTab&&this.setCurrentTab("execution"),this.codeLineHighlight.style.top=1.2*this.flow.currentInstruction+"rem"):(this.code_actions_btns.play_btn.style.display="flex",this.code_actions_btns.stop_btn.style.display="none","execution"===this.currentTab&&this.setCurrentTab("code")),this.codeArea.dispatchEvent(new Event("input"))}updateCodeTab(){this.removeAllTabButtonSelections(),"code"===this.currentTab?(this.code_tabs.code_tab.classList.add("selected"),this.codeArea.disabled=!1,this.codeLineHighlight.style.display="none",this.codeArea.value=this.codeContent,this.codeArea.placeholder="0, 1024, 100, 0"):"execution"===this.currentTab&&(this.code_tabs.execution_tab.classList.add("selected"),this.codeArea.disabled=!0,this.codeLineHighlight.style.display="block",this.codeArea.value=this.computeExecutionContent(),this.codeArea.placeholder=""),this.update()}updateCache(){this.cache,this.firstAddress;for(let t=0;t<6;t++);this.memArea.innerHTML='<tbody><tr>\n\t\t\t\t\t\t\t<td class="memoryAddress">Address</td>\n\t\t\t\t\t\t\t<td class="memoryValue">+3</td>\n\t\t\t\t\t\t\t<td class="memoryValue">+2</td>\n\t\t\t\t\t\t\t<td class="memoryValue">+1</td>\n\t\t\t\t\t\t\t<td class="memoryValue">+0</td>\n\t\t\t\t\t\t</tr></tbody>'}updateDetails(){this.details_inputs.accesses.value=`${this.cache.accesses}`,this.details_inputs.hits.value=`${this.cache.hits} (${100*this.cache.getHitsRatio()}%)`,this.details_inputs.misses.value=`${this.cache.miss} (${100*this.cache.getMissessRatio()}%)`,this.details_inputs.amat.value=`${this.cache.getAMAT()}`}update(){this.updateCode(),this.updateCache(),this.updateDetails()}removeAllTabButtonSelections(){this.code_tabs.code_tab.classList.remove("selected"),this.code_tabs.execution_tab.classList.remove("selected")}setCurrentTab(t){this.currentTab!==t&&(["code","execution"].includes(t)?this.currentTab=t:this.currentTab="code",this.updateCodeTab())}computeExecutionContent(){return this.flow.parser.parsed.join("\n")}};e.setupUI(s),e.setParser(new class{reads="";parsed=[];constructor(t){void 0!==t&&this.takeFile(t)}takeFile(t){this.reads=t}validate_reads(){let t=this.reads;if("string"!=typeof t)return!1;if(""===t)return!0;t=t.replaceAll("\n",""),t=t.replaceAll(" ","");for(let e=0;e<t.length;e++)if(!"0123456789,".includes(t[e]))return!1;return!t.split(",").includes("")}seperate_reads(){this.parsed=[];let t=this.reads.replaceAll("\n","").replaceAll(" ","").split(",");t=t.filter((function(t){return""!==t}));for(let e=0;e<t.length;e++)this.parsed.push(parseInt(t[e]))}}),s.setup(t,e)})();